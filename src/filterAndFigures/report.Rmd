---
title: "filtering report"
#code-author: MaartenPostuma
#date: 23-07-2019
output:
  html_document:
    df_print: paged
params:
  dir: "vcf/"
  rmd: "report.Rmd"
  args: myargs

#### author: `r system("whoami",inter=T)`
#### date: `r system("date",intern=T)`
---

```{r setup, include=FALSE}

#setwd("./output")
chooseCRANmirror(graphics=FALSE, ind=33)
args <- commandArgs(TRUE)
usePackage <- function(p) 
{
  if (!is.element(p, installed.packages()[,1]))
    install.packages(p, dep = TRUE)
  require(p, character.only = TRUE)
}
usePackage("ggplot2")
usePackage("ggpubr")
usePackage("knitr")
usePackage("ggdendro")
usePackage("ggrepel")
usePackage("rmarkdown")
usePackage("DT")
usePackage("reshape2")
options(stringsAsFactors = FALSE)

knitr::opts_chunk$set(echo = FALSE)
options(tinytex.verbose = TRUE)
knitr::opts_knit$set(root.dir = '../../')
```

This report contains all the information needed to make descisions about your filtering steps.

# Filter Steps {.tabset .tabset-fade .tabset-pills}

## First Steps

The distribution of individual missingness

```{r fig.cap="Fig.1: Histogram of the fraction of missingness across individuals, red line indicates the cutoff used in filtering step 2"}
indCoverage<-read.table(paste0(params$args[1],"filters/missingIndvs.imiss"),h=T)
cutOff<-as.numeric(system("cat config.yaml | grep 'individual_missingness'| cut -f2 -d :",intern=T))
if(cutOff==0.0){
  cutOff<-0.8
}
popMapFilter<-read.table(paste0(params$args[1],"/stacksFiles/popmapFiltered.tsv"))
numberOfIndividuals<-nrow(popMapFilter)
popmap<-read.table(paste0(params$args[1],"/stacksFiles/popmap.tsv"))

ggplot(indCoverage,aes(x=F_MISS))+geom_histogram(col="black",fill="lightblue",binwidth=0.025)+
  ggtitle(paste0(numberOfIndividuals,"out of ",nrow(popmap)))+ylab("fraction missing")+
  theme_light()+geom_vline(xintercept=cutOff,col="red")

```

Below is a list of the samples that were excluded from the analysis
```{r}
popmap$V1[!popmap$V1%in%popMapFilter$V1]

```

```{r,message=FALSE,results='asis',error=TRUE, fig.cap=paste("")}
parameters<-read.table("src/filterAndFigures/paramTest.tsv",h=T)
pcaData<-read.table(paste0(params$args[1],"filters/pcaAll.tsv"),h=T)
treeSegments<-read.table(paste0(params$args[1],"filters/treeSegmentsAll.tsv"),h=T)
treeLabels<-read.table(paste0(params$args[1],"filters/treeLabelsAll.tsv"),h=T)
popStats<-read.table(paste0(params$args[1],"filters/popStatsAll.tsv"),h=T)

for(j in 1:length(unique(parameters$max_missing))){
max_missing<-unique(parameters$max_missing)[j]
cat(paste0("\n\n## Max missing =",max_missing,"{.tabset .tabset-fade .tabset-pills}"))
cat("\n\n### PCA {.tabset .tabset-fade .tabset-pills}\n")
for(i in 1:length(unique(parameters$maf))){
  
maf<-unique(pcaData$maf)[i]
cat("\n\n#### maf =", maf, "\n")

pcaDataSub<-pcaData[pcaData$max_missing==max_missing&pcaData$maf==maf,]  
print(ggplot(pcaDataSub,aes(x=PCA1,y=PCA2,col=metaPop,label=pop))+
  geom_point()+
  geom_text_repel()+
  theme_pubr()+
  xlab(paste0("PCA 1 (",round(mean(pcaDataSub$PCA1Var),2)*100,"%)"))+
  ylab(paste0("PCA 2 (",round(mean(pcaDataSub$PCA2Var),2)*100,"%)"))+
  ggtitle(paste0("PCA Max missing = ",max_missing," maf= ",maf," nSNP=",pcaDataSub$nSNPs)))



}

cat("\n\n### Clusters {.tabset .tabset-fade .tabset-pills}\n")

for(i in 1:length(unique(parameters$maf))){
 maf<-unique(parameters$maf)[i]
 cat("\n\n#### maf = ", maf, "\n")

 treeSegmentsSub<-treeSegments[treeSegments$max_missing==max_missing&treeSegments$maf==maf,]
 treeLabelsSub<-treeLabels[treeLabels$max_missing==max_missing&treeLabels$maf==maf,]

 print(ggplot(treeSegmentsSub) +
   geom_segment(aes(x = x, y = y, xend = xend, yend=yend))+
   theme_pubr()+coord_cartesian(ylim=c(-3,max(treeSegmentsSub$y)*1.15))+
   geom_text(data = treeLabelsSub, aes(x, y, label = label,col=metaPop),
             hjust = 1, angle = 90, size = 5)+
   xlab("")+
   ylab("genetic distance")+
   ggtitle(paste("number of SNPs =",unique(treeLabelsSub$nSNPs),"\n maxMissing =",max_missing,"\n maf =",maf)))
}
cat("\n\n### PopStats {.tabset .tabset-fade .tabset-pills}\n")


for(i in 1:length(unique(parameters$maf))){
 maf<-unique(parameters$maf)[i]
 cat("\n\n#### maf = ", maf, "\n")

popStatsSub<-popStats[popStats$max_missing==max_missing&popStats$maf==maf,]
moltenPopStats<-melt(popStatsSub,id.vars=c("pop","max_missing","maf"))
print(ggplot(moltenPopStats,aes(x=pop,y=value,col=metaPop))+
  geom_col()+
  facet_wrap(.~variable,scales = "free")+
  theme_pubr()
)

}
}
```

## Popstats

```{r}
popStats<-read.table(paste0(params$args[1],"filters/popStatsAll.tsv"),h=T)
popStats[-1]<-round(popStats[-c(1,ncol(popStats))],digit=2)
popStats$maf<-as.factor(popStats$maf)
popStats$max_missing<-as.factor(popStats$max_missing)
datatable(popStats,filter = "top")

```